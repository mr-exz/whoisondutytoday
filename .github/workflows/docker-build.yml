name: Docker Build CI

on:
  push:
    branches:
      - '**'
    paths-ignore:
      - 'CHANGELOG.md'
  pull_request:
    branches:
      - master
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish to Docker Hub after build'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-latest

    # Skip build on technical commits (those with [skip ci])
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    outputs:
      docker_tag: ${{ steps.docker-tag.outputs.tag }}
      is_master: ${{ steps.check-branch.outputs.is_master }}

    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Determine branch and tag
        id: check-branch
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "is_master=true" >> $GITHUB_OUTPUT
          else
            echo "is_master=false" >> $GITHUB_OUTPUT
          fi

      - name: Set Docker tag
        id: docker-tag
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "tag=latest" >> $GITHUB_OUTPUT
          else
            BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g')
            echo "tag=$BRANCH_NAME" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          TAG="${{ steps.docker-tag.outputs.tag }}"
          echo "ðŸ”¨ Building Docker image with tag: $TAG"
          make build TAG=$TAG
          echo "âœ… Docker image built successfully: mrexz/whoisondutytoday:$TAG"

  publish:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and push Docker image
        run: |
          TAG="${{ needs.build.outputs.docker_tag }}"
          echo "ðŸš€ Publishing Docker image to registry: mrexz/whoisondutytoday:$TAG"
          make build TAG=$TAG
          make tag-latest
          make push
          echo "âœ… Docker image published successfully"
          echo ""
          echo "ðŸ“¦ Image tags:"
          echo "   - mrexz/whoisondutytoday:$TAG"
          echo "   - mrexz/whoisondutytoday:latest"